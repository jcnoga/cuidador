<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conexão Cuidado</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #27ae60; /* Verde */
            --accent: #e67e22;    /* Laranja */
            --light: #f8f9fa;
            --danger: #e74c3c;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #e9ecef; color: #333; padding-bottom: 50px; }

        /* --- Header --- */
        header { background: var(--primary); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header h1 { font-size: 1.3rem; display: flex; align-items: center; gap: 10px; }
        
        /* Botão Sair no Header */
        .btn-logout-header { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; display: none; }
        .btn-logout-header:hover { background: var(--danger); }

        /* --- Layout --- */
        .container { max-width: 1100px; margin: 30px auto; padding: 0 20px; }
        .view-section { display: none; animation: fadeIn 0.4s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Cards & Inputs --- */
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ced4da; border-radius: 6px; }
        
        /* --- Buttons --- */
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-primary:hover { background: #219150; }
        .btn-outline { background: transparent; border: 2px solid var(--secondary); color: var(--secondary); margin-top: 10px; }
        
        /* Google Btn */
        .btn-google { background: white; color: #555; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .btn-google:hover { background: #f1f1f1; }

        /* --- Grid Perfis --- */
        .profiles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .profile-card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .profile-header { background: var(--primary); color: white; padding: 15px; text-align: center; }
        .profile-body { padding: 15px; }

        /* --- Modal --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); }
        .modal-content { background: white; margin: 10% auto; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; text-align: center; position: relative; }
        .close-btn { position: absolute; right: 15px; top: 10px; font-size: 24px; cursor: pointer; }

        /* --- Links --- */
        .link-text { color: var(--secondary); cursor: pointer; text-decoration: underline; font-weight: bold; }
        
        /* Loader */
        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 2000; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loader"><i class="fas fa-spinner fa-spin fa-2x" style="color:var(--secondary)"></i></div>

    <!-- HEADER -->
    <header>
        <h1><i class="fas fa-heartbeat"></i> Conexão Cuidado</h1>
        <div id="user-nav">
            <button id="header-logout-btn" class="btn-logout-header" onclick="doLogout()">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </div>
    </header>

    <!-- 1. TELA DE LOGIN -->
    <section id="login-section" class="view-section active">
        <div class="container" style="max-width: 400px;">
            <div class="card">
                <h2 style="text-align:center; color:var(--primary); margin-bottom:20px;">Entrar</h2>

                <!-- Botão Google -->
                <button class="btn btn-google" id="btn-google-login">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> 
                    Entrar com Google
                </button>

                <div style="display:flex; align-items:center; margin: 15px 0; color:#999; font-size:0.8rem;">
                    <hr style="flex:1;"> <span style="padding:0 10px;">OU E-MAIL</span> <hr style="flex:1;">
                </div>

                <form id="login-form">
                    <input type="email" id="login-email" placeholder="E-mail" required>
                    <input type="password" id="login-pass" placeholder="Senha" required>
                    <button type="submit" class="btn btn-primary">Acessar</button>
                </form>

                <div style="text-align:center; margin-top: 20px; font-size: 0.9rem;">
                    <a onclick="window.router('forgot')" style="color:#666; cursor:pointer;">Esqueci minha senha</a>
                </div>

                <!-- SEÇÃO "NÃO TEM CONTA?" -->
                <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; text-align: center;">
                    <p>Não tem conta?</p>
                    <button class="btn btn-outline" onclick="openRoleSelector()">Cadastre-se Aqui</button>
                </div>
            </div>
        </div>
    </section>

    <!-- MODAL DE ESCOLHA DE PERFIL (Cadastro) -->
    <div id="role-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('role-modal').style.display='none'">&times;</span>
            <h3 style="color:var(--primary)">Como você deseja se cadastrar?</h3>
            <p style="margin:15px 0; color:#666;">Escolha o perfil que melhor se adapta a você:</p>
            
            <div style="display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">
                <button class="btn btn-primary" style="background:#3498db;" onclick="goToRegister('assistido')">
                    <i class="fas fa-user-injured fa-2x" style="display:block; margin-bottom:5px;"></i>
                    Sou Família<br>(Busco Cuidado)
                </button>
                <button class="btn btn-primary" style="background:var(--accent);" onclick="goToRegister('cuidador')">
                    <i class="fas fa-user-nurse fa-2x" style="display:block; margin-bottom:5px;"></i>
                    Sou Profissional<br>(Cuidador)
                </button>
            </div>
        </div>
    </div>

    <!-- 2. TELA DE CADASTRO -->
    <section id="register-section" class="view-section">
        <div class="container" style="max-width: 600px;">
            <div class="card">
                <h2 id="reg-title" style="color:var(--primary); margin-bottom:15px;">Cadastro</h2>
                <form id="reg-form">
                    <input type="hidden" id="reg-type">
                    
                    <label>Dados Pessoais</label>
                    <input type="text" id="reg-name" placeholder="Nome Completo" required>
                    <input type="tel" id="reg-phone" placeholder="WhatsApp (DDD + Número)" required>
                    
                    <!-- Email/Senha (Se for cadastro normal) -->
                    <div id="auth-fields-container">
                        <input type="email" id="reg-email" placeholder="E-mail" required>
                        <input type="password" id="reg-pass" placeholder="Senha (Mínimo 6 caracteres)">
                    </div>

                    <div style="display:flex; gap:10px;">
                        <input type="text" id="reg-city" placeholder="Cidade" required>
                        <input type="text" id="reg-district" placeholder="Bairro" required>
                    </div>
                    <input type="text" id="reg-photo" placeholder="Link da Foto (Opcional)">

                    <!-- CAMPOS ESPECÍFICOS -->
                    <div id="fields-assistido" style="display:none; margin-top:20px; padding-top:10px; border-top:1px solid #eee;">
                        <h4 style="color:var(--primary)">Dados do Assistido</h4>
                        <input type="number" id="reg-age-a" placeholder="Idade">
                        <select id="reg-condition">
                            <option value="" disabled selected>Condição Principal</option>
                            <option value="Idoso">Idoso</option>
                            <option value="Alzheimer">Alzheimer</option>
                            <option value="Acamado">Acamado</option>
                            <option value="PcD Física">PcD Física</option>
                            <option value="Outro">Outro</option>
                        </select>
                        <label>Horário:</label>
                        <select id="reg-schedule-a">
                            <option value="Integral">Integral</option>
                            <option value="Meio Período">Meio Período</option>
                            <option value="Plantão">Plantão 12x36</option>
                            <option value="Finais de Semana">Finais de Semana</option>
                        </select>
                    </div>

                    <div id="fields-cuidador" style="display:none; margin-top:20px; padding-top:10px; border-top:1px solid #eee;">
                        <h4 style="color:var(--accent)">Dados Profissionais</h4>
                        <input type="number" id="reg-age-c" placeholder="Idade">
                        <select id="reg-formation">
                            <option value="Cuidador">Cuidador (Curso)</option>
                            <option value="Téc. Enfermagem">Técnico de Enfermagem</option>
                            <option value="Enfermeiro">Enfermeiro(a)</option>
                            <option value="Experiência">Experiência Familiar</option>
                        </select>
                        <input type="number" id="reg-exp" placeholder="Anos de Experiência">
                        <input type="text" id="reg-price" placeholder="Valor (ex: R$ 150/dia)">
                    </div>

                    <div style="margin-top:20px;">
                        <button type="submit" class="btn btn-primary">Finalizar Cadastro</button>
                        <button type="button" class="btn btn-outline" style="border:none;" onclick="window.router('login')">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- 3. DASHBOARD (PAINEL) -->
    <section id="dashboard-section" class="view-section">
        <div class="container">
            <div class="card" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
                <div>
                    <h2 id="dash-title" style="margin:0; color:var(--primary)">Painel</h2>
                    <p id="dash-subtitle" style="color:#666; font-size:0.9rem;">Bem-vindo ao sistema</p>
                </div>
                <!-- Filtro -->
                <input type="text" id="search-input" placeholder="Buscar por nome ou cidade..." style="max-width:300px;">
            </div>

            <!-- Botão Meu Perfil (Toggle) -->
            <button onclick="toggleMyProfile()" style="background:none; border:none; color:var(--secondary); cursor:pointer; margin-bottom:15px; text-decoration:underline;">
                <i class="fas fa-cog"></i> Configurar meu status (Visibilidade)
            </button>

            <div id="my-profile-area" class="card" style="display:none; border:1px solid var(--secondary);">
                <h4>Meu Status</h4>
                <div style="display:flex; gap:10px; align-items:center;">
                    <select id="my-status-select" style="max-width:200px;">
                        <option value="true">Visível (Buscando)</option>
                        <option value="false">Oculto (Indisponível)</option>
                    </select>
                    <button class="btn btn-primary" onclick="updateStatus()" style="width:auto;">Salvar</button>
                </div>
            </div>

            <div id="results-grid" class="profiles-grid">
                <!-- JS PREENCHE -->
            </div>
        </div>
    </section>

    <!-- 4. RECUPERAR SENHA -->
    <section id="forgot-section" class="view-section">
        <div class="container" style="max-width:400px">
            <div class="card">
                <h3>Recuperar Senha</h3>
                <input type="email" id="forgot-email" placeholder="Seu E-mail cadastrado">
                <button class="btn btn-primary" onclick="recoverPass()">Enviar E-mail</button>
                <button class="btn btn-outline" onclick="window.router('login')" style="border:none;">Voltar</button>
            </div>
        </div>
    </section>

    <!-- 5. ADMIN -->
    <section id="admin-section" class="view-section">
        <div class="container">
            <h2>Administração</h2>
            <div class="card">
                <div id="admin-content">Carregando...</div>
            </div>
        </div>
    </section>

    <!-- MODAL DETALHES -->
    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('detail-modal').style.display='none'">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <!-- JAVASCRIPT / FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, updateDoc, collection, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Configuração
        const firebaseConfig = {
            apiKey: "AIzaSyCd40YOqcJP-kWvsdX9TNxym1Baz-btDIM",
            authDomain: "cuidador-2b862.firebaseapp.com",
            projectId: "cuidador-2b862",
            storageBucket: "cuidador-2b862.firebasestorage.app",
            messagingSenderId: "253776267698",
            appId: "1:253776267698:web:f5b8af9d3d64d77e06fcab",
            measurementId: "G-JJS8HEBS5V"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentUserData = null;
        let isGoogleRegister = false;

        // --- GLOBAL FUNCTIONS ---
        window.loader = (show) => document.getElementById('loader').style.display = show ? 'flex' : 'none';
        
        window.router = (screen) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            const target = document.getElementById(screen + '-section');
            if(target) target.classList.add('active');
            
            // Botão sair
            const btnLogout = document.getElementById('header-logout-btn');
            if (screen === 'dashboard' || screen === 'admin') {
                btnLogout.style.display = 'block';
            } else {
                btnLogout.style.display = 'none';
            }

            if(screen === 'dashboard') loadDashboard();
            if(screen === 'admin') loadAdmin();
        };

        window.openRoleSelector = () => {
            document.getElementById('role-modal').style.display = 'block';
        };

        window.goToRegister = (type) => {
            document.getElementById('role-modal').style.display = 'none';
            window.router('register');
            setupRegister(type);
        };

        window.toggleMyProfile = () => {
            const el = document.getElementById('my-profile-area');
            el.style.display = (el.style.display === 'none') ? 'block' : 'none';
        }

        window.doLogout = () => {
            signOut(auth).then(() => {
                currentUser = null;
                currentUserData = null;
                window.router('login');
                alert("Você saiu do sistema.");
            });
        };

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const snap = await getDoc(doc(db, "users", user.uid));
                    if(snap.exists()) {
                        currentUserData = snap.data();
                        
                        // Fecha modal se estiver aberto
                        document.getElementById('role-modal').style.display = 'none';

                        if(currentUserData.type === 'admin') window.router('admin');
                        else window.router('dashboard');
                    } else {
                        // Novo usuário Google sem cadastro
                        document.getElementById('role-modal').style.display = 'block';
                        window.router('login'); // Mantém no fundo
                    }
                } catch(e) { console.error(e); }
            } else {
                window.router('login');
            }
        });

        // LOGIN EMAIL
        document.getElementById('login-form').addEventListener('submit', async(e)=>{
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            window.loader(true);
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch(e) {
                alert("Erro: " + e.message);
                window.loader(false);
            }
        });

        // LOGIN GOOGLE
        document.getElementById('btn-google-login').addEventListener('click', async()=>{
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch(e) {
                if(e.code === 'auth/unauthorized-domain') {
                    alert("Erro de Domínio: O Google ainda não reconheceu seu site. Aguarde 30 min ou use Login com Email/Senha por enquanto.");
                } else {
                    alert("Erro Google: " + e.message);
                }
            }
        });

        // --- CADASTRO ---
        function setupRegister(type) {
            document.getElementById('reg-form').reset();
            document.getElementById('reg-type').value = type;
            document.getElementById('reg-title').innerText = type === 'assistido' ? "Cadastro Família" : "Cadastro Cuidador";
            
            document.getElementById('fields-assistido').style.display = (type === 'assistido') ? 'block' : 'none';
            document.getElementById('fields-cuidador').style.display = (type === 'cuidador') ? 'block' : 'none';

            // Se for Google, preenche e trava email
            if(currentUser && !currentUserData) {
                isGoogleRegister = true;
                document.getElementById('reg-name').value = currentUser.displayName || "";
                document.getElementById('reg-email').value = currentUser.email || "";
                document.getElementById('reg-photo').value = currentUser.photoURL || "";
                
                document.getElementById('reg-email').disabled = true;
                document.getElementById('auth-fields-container').style.display = 'none';
            } else {
                isGoogleRegister = false;
                document.getElementById('reg-email').disabled = false;
                document.getElementById('auth-fields-container').style.display = 'block';
            }
        }

        document.getElementById('reg-form').addEventListener('submit', async(e)=>{
            e.preventDefault();
            window.loader(true);
            
            const type = document.getElementById('reg-type').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const name = document.getElementById('reg-name').value;

            try {
                let uid;
                if(isGoogleRegister) {
                    uid = currentUser.uid;
                } else {
                    if(pass.length < 6) throw new Error("Senha muito curta.");
                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    uid = cred.user.uid;
                }

                const data = {
                    uid: uid, type: type, name: name, email: email,
                    phone: document.getElementById('reg-phone').value,
                    city: document.getElementById('reg-city').value,
                    district: document.getElementById('reg-district').value,
                    photo: document.getElementById('reg-photo').value || 'https://via.placeholder.com/150',
                    active: true, createdAt: new Date()
                };

                if(type === 'assistido') {
                    data.age = document.getElementById('reg-age-a').value;
                    data.condition = document.getElementById('reg-condition').value;
                    data.schedule = document.getElementById('reg-schedule-a').value;
                } else {
                    data.age = document.getElementById('reg-age-c').value;
                    data.formation = document.getElementById('reg-formation').value;
                    data.exp = document.getElementById('reg-exp').value;
                    data.price = document.getElementById('reg-price').value;
                }

                await setDoc(doc(db, "users", uid), data);
                alert("Cadastrado com sucesso!");
                window.location.reload(); // Recarrega para limpar estados

            } catch(e) {
                alert("Erro: " + e.message);
                window.loader(false);
            }
        });

        // --- DASHBOARD ---
        async function loadDashboard() {
            if(!currentUserData) return;
            const grid = document.getElementById('results-grid');
            const title = document.getElementById('dash-title');
            const sub = document.getElementById('dash-subtitle');

            let targetType = (currentUserData.type === 'assistido') ? 'cuidador' : 'assistido';
            
            if(currentUserData.type === 'assistido') {
                title.innerText = "Encontrar Cuidadores";
                sub.innerText = "Profissionais disponíveis na sua região";
            } else {
                title.innerText = "Vagas Disponíveis";
                sub.innerText = "Famílias precisando de ajuda";
            }

            document.getElementById('my-status-select').value = currentUserData.active.toString();
            window.loader(true);

            try {
                const q = query(collection(db, "users"), where("type", "==", targetType), where("active", "==", true));
                const snap = await getDocs(q);
                
                grid.innerHTML = '';
                if(snap.empty) grid.innerHTML = '<p>Nenhum resultado encontrado.</p>';

                snap.forEach(d => {
                    const u = d.data();
                    
                    // Filtro JS simples
                    const term = document.getElementById('search-input').value.toLowerCase();
                    if(term && !u.name.toLowerCase().includes(term) && !u.city.toLowerCase().includes(term)) return;

                    let info = u.type === 'assistido' 
                        ? `${u.condition} • ${u.schedule}` 
                        : `${u.formation} • ${u.price}`;

                    grid.innerHTML += `
                        <div class="profile-card">
                            <div class="profile-header">
                                <img src="${u.photo}" style="width:60px; height:60px; border-radius:50%; object-fit:cover; border:2px solid white;">
                                <h3>${u.name}</h3>
                                <small>${u.city} - ${u.district}</small>
                            </div>
                            <div class="profile-body">
                                <p style="text-align:center; font-weight:bold; color:var(--secondary)">${info}</p>
                                <button class="btn btn-primary" onclick="showDetails('${u.uid}')" style="margin-top:10px;">Ver Contato</button>
                            </div>
                        </div>
                    `;
                });

            } catch(e) { console.error(e); }
            finally { window.loader(false); }
        }

        document.getElementById('search-input').addEventListener('keyup', loadDashboard);

        // --- STATUS UPDATE ---
        window.updateStatus = async () => {
            const val = document.getElementById('my-status-select').value === 'true';
            try {
                await updateDoc(doc(db, "users", currentUser.uid), { active: val });
                currentUserData.active = val;
                alert("Status atualizado!");
                loadDashboard();
            } catch(e) { alert("Erro"); }
        }

        // --- DETALHES ---
        window.showDetails = async (uid) => {
            window.loader(true);
            const snap = await getDoc(doc(db, "users", uid));
            window.loader(false);
            if(snap.exists()) {
                const u = snap.data();
                const body = document.getElementById('modal-body');
                let extra = u.type === 'assistido' 
                    ? `<p><strong>Condição:</strong> ${u.condition}</p><p><strong>Horário:</strong> ${u.schedule}</p>`
                    : `<p><strong>Formação:</strong> ${u.formation}</p><p><strong>Exp:</strong> ${u.exp} anos</p><p><strong>Valor:</strong> ${u.price}</p>`;

                body.innerHTML = `
                    <div style="text-align:center">
                        <img src="${u.photo}" style="width:100px; height:100px; border-radius:50%; object-fit:cover;">
                        <h2>${u.name}</h2>
                        <p>${u.city}</p>
                        <hr style="margin:10px 0;">
                        ${extra}
                        <br>
                        <a href="https://wa.me/55${u.phone.replace(/\D/g,'')}" target="_blank" class="btn btn-primary" style="text-decoration:none; display:block;">Chamar no WhatsApp</a>
                    </div>
                `;
                document.getElementById('detail-modal').style.display = 'block';
            }
        };

        // --- RECOVER PASS ---
        window.recoverPass = async () => {
            const email = document.getElementById('forgot-email').value;
            if(!email) return alert("Digite o email");
            try {
                await sendPasswordResetEmail(auth, email);
                alert("Email enviado!");
                window.router('login');
            } catch(e) { alert("Erro: " + e.message); }
        }

        // --- ADMIN ---
        async function loadAdmin() {
            const div = document.getElementById('admin-content');
            const snap = await getDocs(collection(db, "users"));
            let html = '<table style="width:100%"><tr><th>Nome</th><th>Tipo</th><th>Email</th></tr>';
            snap.forEach(d => {
                const u = d.data();
                html += `<tr><td>${u.name}</td><td>${u.type}</td><td>${u.email}</td></tr>`;
            });
            html += '</table>';
            div.innerHTML = html;
        }

    </script>
</body>
</html>